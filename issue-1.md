# Issue #1: Generated BDF fonts have incorrect character encodings

**Status**: Identified and Reproduced
**Severity**: High - Fonts do not render in applications
**Component**: Font conversion pipeline (converter.py)

## Problem Summary

BDF fonts generated by cp-font-gen use **sequential encodings** (1, 2, 3, 4...) instead of correct **Unicode codepoints** (48, 49, 50, 51... for digits '0', '1', '2', '3'...).

This causes the fonts to fail rendering in any application that looks up characters by their Unicode codepoint, including:
- CircuitPython displayio
- Blinka displayio with pygame
- Any standards-compliant BDF font renderer

## Example

### Expected (Correct) BDF Encoding
```
STARTCHAR zero
ENCODING 48     ← Correct: ASCII/Unicode for '0'
BITMAP
...
ENDCHAR

STARTCHAR one
ENCODING 49     ← Correct: ASCII/Unicode for '1'
BITMAP
...
ENDCHAR
```

### Actual (Incorrect) BDF Encoding
```
STARTCHAR 0001
ENCODING 1      ← Wrong: Should be 48
BITMAP
...
ENDCHAR

STARTCHAR 0002
ENCODING 2      ← Wrong: Should be 49
BITMAP
...
ENDCHAR
```

## Impact

When rendering the string "0123456789":
1. Text renderer looks for character '0' at codepoint 48
2. Font only has a glyph at encoding 1
3. Glyph not found → nothing renders
4. **Result**: Text is invisible despite font loading successfully

## Root Cause

The issue is in `src/cp_font_gen/converter.py` in the `generate_subset_font()` function.

When `fontTools.subset` creates a subset font:
1. It correctly receives Unicode ranges (e.g., U+0030-U+0039 for digits)
2. It creates a subset TTF with those glyphs
3. **BUT** it may remap the character map (cmap) table sequentially
4. The subset font's cmap maps glyphs as 1, 2, 3... instead of 48, 49, 50...
5. `otf2bdf` reads this remapped cmap
6. BDF file gets wrong ENCODING values

## Evidence

From manifest (shows correct input):
```json
{
  "unicode_ranges": [
    "U+0030",  ← Decimal 48: '0'
    "U+0031",  ← Decimal 49: '1'
    "U+0032",  ← Decimal 50: '2'
    ...
  ]
}
```

From generated BDF (shows incorrect output):
```
ENCODING 1     ← Should be 48
ENCODING 2     ← Should be 49
ENCODING 3     ← Should be 50
```

## Reproduction

### Setup
```bash
# Generate a digit font
cd cp-font-gen
# Use config that generates digits font

# Check the BDF encodings
grep "ENCODING" output/digits/digits-16pt.bdf
# Shows: 1, 2, 3, 4, 5, 6, 7, 8, 9, 10
# Should be: 48, 49, 50, 51, 52, 53, 54, 55, 56, 57
```

### Test Rendering
```bash
# Try to render with the font
cd ../bitmap-font-research
./run_test.sh test_var04_custom_font
# Result: FAILS - no text appears
```

See `tests/test_issue_1.py` in this branch for automated reproduction.

## Solution

### Option 1: Post-Process BDF (Implemented in this branch)

After BDF generation, fix ENCODING values to match the requested Unicode codepoints.

**Location**: Add to `converter.py` after `convert_to_bdf()`

**Approach**:
1. Read the generated BDF file
2. Replace ENCODING values with correct Unicode codepoints
3. Use the same Unicode list that was passed to `generate_subset_font()`

**Pros**:
- Simple to implement
- Works regardless of fontTools behavior
- Guarantees correct encodings

**Cons**:
- Post-processing overhead
- Doesn't fix root cause in fontTools usage

### Option 2: Fix fontTools Configuration (Future improvement)

Research and configure `fontTools.subset` to preserve original cmap.

**Requires**:
- Deep dive into fontTools.subset.Options
- Understanding of cmap table preservation
- Testing across different font types

## Fix Implementation

The fix in this branch implements **Option 1** (post-processing).

See `src/cp_font_gen/converter.py` for the implementation.

## Testing

After applying the fix:

```bash
# Regenerate fonts
cd cp-font-gen
# regenerate with fix applied

# Verify encodings are correct
grep "ENCODING" output/digits/digits-16pt.bdf
# Should now show: 48, 49, 50, 51, 52, 53, 54, 55, 56, 57

# Test rendering
cd ../bitmap-font-research
./run_test.sh test_var04_custom_font
# Should PASS - text renders correctly
```

## References

- ASCII table: '0'-'9' are codepoints 48-57
- BDF Specification: https://adobe-type-tools.github.io/font-tech-notes/pdfs/5005.BDF_Spec.pdf
- fontTools documentation: https://fonttools.readthedocs.io/
- Issue investigation: `../bitmap-font-research/docs/ROOT_CAUSE.md`
